{% extends "base.html" %}
{% block title %}New Post{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
  <div>
    <p class="text-xs text-mist uppercase tracking-[0.16em] mb-1">Admin</p>
    <h1 class="text-2xl font-semibold">New Post</h1>
  </div>
  <a href="/admin/posts" class="text-sm text-mist hover:text-sand border border-bark rounded-full px-3 py-2">
    Back to posts
  </a>
</div>

{% if success %}
  <div class="mb-6 p-4 rounded border border-leaf/40 bg-leaf/10 text-sand">
    <p class="font-medium">Post created successfully!</p>

    {% if slug %}
      <div class="mt-2">
        <p class="mt-1 text-sm">
          View post:
          <a href="/news/{{ slug }}" class="text-leaf hover:underline">
            /news/{{ slug }}
          </a>
        </p>
      </div>
    {% endif %}

    {% if saved_images %}
      <div class="mt-3 text-sm">
        Uploaded images:
        <ul class="list-disc list-inside">
          {% for img in saved_images %}
            <li><code>{{ img }}</code></li>
          {% endfor %}
        </ul>
        Reference in markdown using:<br>
        <code>![](/media/{{ slug }}/filename.jpg)</code>
      </div>
    {% endif %}
  </div>
{% endif %}

<form method="post" action="/admin/posts/new" enctype="multipart/form-data" class="card p-6 space-y-6">

  <!-- TITLE -->
  <div>
    <label for="title" class="block text-sm font-medium mb-1 text-mist">Title</label>
    <input
      name="title"
      id="title"
      class="w-full px-3 py-2 text-sm"
      hx-post="/admin/generate-slug"
      hx-trigger="keyup changed delay:300ms"
      hx-target="#slug-wrapper"
      hx-swap="outerHTML"
    />
  </div>

  <!-- SLUG (INPUT + PREVIEW, UPDATED TOGETHER) -->
  <div>
    <label class="block text-sm font-medium mb-1 text-mist">Slug (URL)</label>

    <div id="slug-wrapper">
      {% include "partials/slug_field.html" %}
    </div>
  </div>

  <!-- MARKDOWN EDITOR -->
  <div>
    <label class="block text-sm font-medium mb-1 text-mist">Body (Markdown)</label>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

      <!-- Editor -->
      <textarea
        name="body"
        id="body-editor"
        rows="14"
        class="w-full px-3 py-2 font-mono text-sm bg-[#0f1a15] border border-bark rounded-lg"
        placeholder="# Heading

Your post content here..."
      ></textarea>

      <!-- Preview -->
      <div
        id="preview"
        class="prose prose-invert bg-[#0f1a15] border border-bark rounded-lg px-4 py-3 overflow-y-auto max-h-[32rem]"
      ></div>

    </div>
  </div>

  <!-- IMAGES -->
  <div>
    <label class="block text-sm font-medium mb-1 text-mist">Images (optional)</label>
    <input type="file" name="images" multiple class="block">
    <p class="text-xs text-mist mt-1">
      Uploaded to <code>/media/&lt;slug&gt;/filename</code>
    </p>
  </div>

  <!-- SUBMIT -->
  <button
    type="submit"
    class="px-5 py-3 bg-leaf text-ink rounded-full font-semibold shadow-glow hover:-translate-y-0.5 transition transform"
  >
    Create Post
  </button>
</form>

<!-- MARKDOWN PREVIEW -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  const editor = document.getElementById("body-editor");
  const preview = document.getElementById("preview");

  editor?.addEventListener("input", () => {
    preview.innerHTML = marked.parse(editor.value);
  });
</script>

{% endblock %}
